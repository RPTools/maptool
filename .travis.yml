# Language is set to Java and we build using the Gradle wrapper.
# It would be nice if we could just run "gradlew wrapper" and let it
# update itself, but it currently downloads the stable release of
# gradle-3.2 and we need 4.x+ for the build to work with Java 9 (the
# older version can't parse the 'x.y.z' version string from Java 9).
language: java
sudo: false
script: ./gradlew build

# We have ./.travis/installer.sh to do any installation that is required
# that can't be done using builtin Travis tools.  For both Linux and
# macOS, that means Gradle 4.x, but for macOS it also means downloading
# and installing the Java 9 JDK.  See the contents of the script for
# version number information.
matrix:
    include:
      - os: linux
        jdk: oraclejdk9
        addons:
          apt:
            packages:
                - oracle-java9-installer
                - fakeroot
      - os: osx
        osx_image: xcode9.2
        before_install:
            - brew update
            - brew cask reinstall java
            - java -version

# Shamelessly copied from Jamz's TokenTool configuration file. :)
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"

# This is all copied from Jamz's configuration for TokenTool.
# I can guess at some of it, but I haven't read the docs for the
# deployment configuration so much of it is Greek to me.  Still,
# putting it here means I don't have to go look it up later when I want
# to play with it.
#
# And of course, the 'deploy' task needs to be added to build.gradle. 
# It looks pretty simple for TokenTool, but it has three dependencies
# that I haven't investigated...

before_deploy:
  - ./gradlew deploy
deploy:
  provider: releases
  api_key:
    secure: $DEPLOYMENT_KEY
  file_glob: true
  file: releases/release-*/*
  overwrite: true
  skip_cleanup: true
  target_commitish: $TRAVIS_COMMIT
  tag_name: $TRAVIS_TAG
  draft: true
  on:
    repo: RPTools/maptool
    tags: true
